/*
 * Selecter Plugin [Formstone Library]
 * @author Ben Plum
 * @version 2.2.1
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(e){function u(a){a=e.extend({},v,a||{});for(var b=e(this),f=0,c=b.length;f<c;f++){var h=b.eq(f),g=a;if(!h.data("selecter")){g.externalLinks&&(g.links=!0);e.extend(g,h.data("selecter-options"));var k=h.find("option, optgroup"),p=k.filter("option"),m=p.filter(":selected"),s=g.defaultLabel?-1:p.index(m),t=k.length-1,w=g.links?"nav":"div",x=g.links?"a":"span";g.multiple=h.prop("multiple");g.disabled=h.is(":disabled");var d="<"+w+' class="selecter '+g.customClass;n?d+=" mobile":g.cover&&(d+= " cover");d=g.multiple?d+" multiple":d+" closed";g.disabled&&(d+=" disabled");d+='">';g.multiple||(d+='<span class="selecter-selected">',d+=y(g.trimOptions,!1!=g.defaultLabel?g.defaultLabel:m.text()),d+="</span>");for(var d=d+'<div class="selecter-options">',m=0,l=null,q=0,u=k.length;q<u;q++)l=e(k[q]),"OPTGROUP"==l[0].tagName?(d+='<span class="selecter-group',l.is(":disabled")&&(d+=" disabled"),d+='">'+l.attr("label")+"</span>"):(d+="<"+x+' class="selecter-item',l.is(":selected")&&!g.defaultLabel&& (d+=" selected"),l.is(":disabled")&&(d+=" disabled"),0==q&&(d+=" first"),q==t&&(d+=" last"),d+='" ',d=g.links?d+('href="'+l.val()+'"'):d+('data-value="'+l.val()+'"'),d+=">"+y(g.trimOptions,l.text())+"</"+x+">",m++);d+="</div>";d+="</"+w+">";h.addClass("selecter-element").after(d);k=h.next(".selecter");g=e.extend({$selectEl:h,$optionEls:p,$selecter:k,$selected:k.find(".selecter-selected"),$itemsWrapper:k.find(".selecter-options"),$items:k.find(".selecter-item"),index:s,guid:z},g);void 0!=e.fn.scroller&& g.$itemsWrapper.scroller();k.on("click.selecter",".selecter-selected",g,A).on("click.selecter",".selecter-item",g,B).on("selecter-close",g,r).data("selecter",g);if(!g.links&&!n||n){if(h.on("change",g,C).on("blur.selecter",g,D),!n)h.on("focus.selecter",g,E)}else h.hide();z++}}return b}function A(a){a.preventDefault();a.stopPropagation();var b=a.data;if(!b.$selectEl.is(":disabled"))if(e(".selecter").not(b.$selecter).trigger("selecter-close",[b]),n)a=b.$selectEl[0],document.createEvent?(b=document.createEvent("MouseEvents"), b.initMouseEvent("mousedown",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(b)):element.fireEvent&&a.fireEvent("onmousedown");else if(b.$selecter.hasClass("closed")){if(a.preventDefault(),a.stopPropagation(),a=a.data,!a.$selecter.hasClass("open")){var b=a.$selecter.offset(),f=e("body").outerHeight(),c=a.$itemsWrapper.outerHeight(!0);b.top+c>f&&n?a.$selecter.addClass("bottom"):a.$selecter.removeClass("bottom");a.$itemsWrapper.show();a.$selecter.removeClass("closed").addClass("open");e("body").on("click.selecter-"+ a.guid,":not(.selecter-options)",a,F);b=0<=a.index?a.$items.eq(a.index).position():{left:0,top:0};void 0!=e.fn.scroller?a.$itemsWrapper.scroller("scroll",a.$itemsWrapper.find(".scroller-content").scrollTop()+b.top,0).scroller("reset"):a.$itemsWrapper.scrollTop(a.$itemsWrapper.scrollTop()+b.top)}}else b.$selecter.hasClass("open")&&r(a)}function r(a){a.preventDefault();a.stopPropagation();a=a.data;a.$selecter.hasClass("open")&&(a.$itemsWrapper.hide(),a.$selecter.removeClass("open").addClass("closed"), e("body").off(".selecter-"+a.guid))}function F(a){a.preventDefault();a.stopPropagation();0==e(a.currentTarget).parents(".selecter").length&&r(a)}function B(a){a.preventDefault();a.stopPropagation();var b=e(this),f=a.data;f.$selectEl.is(":disabled")||(f.$itemsWrapper.is(":visible")&&(b=f.$items.index(b),p(b,f,!1)),f.multiple||r(a))}function C(a,b){if(!b){var f=e(this),c=a.data;c.links?n?m(f.val(),c.externalLinks):m(f.attr("href"),c.externalLinks):(f=c.$optionEls.index(c.$optionEls.filter("[value='"+ G(f.val())+"']")),p(f,c,!1))}}function E(a){a.preventDefault();a.stopPropagation();a=a.data;a.$selectEl.is(":disabled")||a.multiple||(a.$selecter.addClass("focus"),e(".selecter").not(a.$selecter).trigger("selecter-close",[a]),e("body").on("keydown.selecter-"+a.guid,a,H))}function D(a){a.preventDefault();a.stopPropagation();a=a.data;a.$selecter.removeClass("focus");e(".selecter").not(a.$selecter).trigger("selecter-close",[a]);e("body").off(".selecter-"+a.guid)}function H(a){var b=a.data;if(b.$selecter.hasClass("open")&& 13==a.keyCode)p(b.index,b,!1),r(a);else if(9!=a.keyCode&&!(a.metaKey||a.altKey||a.ctrlKey||a.shiftKey)){a.preventDefault();a.stopPropagation();var f=b.$items.length-1,c=-1;if(-1<e.inArray(a.keyCode,s?[38,40,37,39]:[38,40]))c=b.index+(38==a.keyCode||s&&37==a.keyCode?-1:1),0>c&&(c=0),c>f&&(c=f);else{a=String.fromCharCode(a.keyCode).toUpperCase();for(i=b.index+1;i<=f;i++){var h=b.$optionEls.eq(i).text().charAt(0).toUpperCase();if(h==a){c=i;break}}if(0>c)for(i=0;i<=f;i++)if(h=b.$optionEls.eq(i).text().charAt(0).toUpperCase(), h==a){c=i;break}}0<=c&&p(c,b,!0)}}function p(a,b,f){var c=b.$items.eq(a),e=c.hasClass("selected");if(!c.hasClass("disabled")){if(e)b.multiple&&(b.$optionEls.eq(a).prop("selected",null),c.removeClass("selected"));else{var g=c.html();c.data("value");if(b.multiple)b.$optionEls.eq(a).prop("selected",!0);else if(b.$selected.html(g),b.$items.filter(".selected").removeClass("selected"),f||(b.$selectEl[0].selectedIndex=a),b.links&&!f){n?m(b.$selectEl.val(),b.externalLinks):m(c.attr("href"),b.externalLinks); return}b.$selectEl.trigger("change",[!0]);c.addClass("selected")}if(!e||b.multiple)b.callback.call(b.$selecter,b.$selectEl.val(),a),b.index=a}}function y(a,b){return!1===a?b:b.length>a?b.substring(0,a)+"...":b}function m(a,b){b?window.open(a):window.location.href=a}function G(a){return a.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1")}var s=-1<navigator.userAgent.toLowerCase().indexOf("firefox"),n=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent||navigator.vendor||window.opera), v={callback:function(){},cover:!1,customClass:"",defaultLabel:!1,externalLinks:!1,links:!1,trimOptions:!1},z=0,t={defaults:function(a){v=e.extend(v,a||{});return e(this)},disable:function(a){return e(this).each(function(b,f){var c=e(f).next(".selecter").data("selecter");if("undefined"!=typeof a){var h=c.$items.index(c.$items.filter("[data-value="+a+"]"));c.$items.eq(h).addClass("disabled");c.$optionEls.eq(h).prop("disabled",!0)}else c.$selecter.hasClass("open")&&c.$selecter.find(".selecter-selected").trigger("click"), c.$selecter.addClass("disabled"),c.$selectEl.prop("disabled",!0)})},enable:function(a){return e(this).each(function(b,f){var c=e(f).next(".selecter").data("selecter");if("undefined"!=typeof a){var h=c.$items.index(c.$items.filter("[data-value="+a+"]"));c.$items.eq(h).removeClass("disabled");c.$optionEls.eq(h).prop("disabled",!1)}else c.$selecter.removeClass("disabled"),c.$selectEl.prop("disabled",!1)})},destroy:function(){return e(this).each(function(a,b){var f=e(b),c=f.next(".selecter");c.hasClass("open")&& c.find(".selecter-selected").trigger("click");void 0!=e.fn.scroller&&c.find(".selecter-options").scroller("destroy");f.off(".selecter").removeClass("selecter-element").show();c.off(".selecter").remove()})}};e.fn.selecter=function(a){return t[a]?t[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?this:u.apply(this,arguments)}})(jQuery);